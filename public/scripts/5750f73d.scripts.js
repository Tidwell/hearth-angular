"use strict";angular.module("hearthApp",["ngCookies","ngResource","ngSanitize","ngRoute","angularLocalStorage","ngAnimate","ui.bootstrap"]).config(["$routeProvider","$locationProvider",function(a,b){b.html5Mode(!0),a.when("/main",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/owned",{templateUrl:"views/owned.html",controller:"OwnedCtrl"}).when("/links",{templateUrl:"views/links.html",controller:"LinksCtrl"}).when("/tournaments",{templateUrl:"views/tournaments.html",controller:"TournamentsCtrl"}).when("/spectate",{redirectTo:"/browse"}).when("/spectate/:id",{templateUrl:"views/spectate.html",controller:"SpectateCtrl"}).when("/play",{redirectTo:"/tournaments"}).when("/play/:id",{templateUrl:"views/play.html",controller:"PlayCtrl"}).when("/browse",{templateUrl:"views/browse.html",controller:"BrowseCtrl"}).otherwise({redirectTo:"/tournaments"})}]),angular.module("hearthApp").controller("MainCtrl",["$scope","cards",function(a,b){a.cardWidth=235,a.cardList=b.get()}]),angular.module("hearthApp").service("cards",["$http",function(a){function b(a){return a.collectible&&"hero"!==a.type}var c={cards:[]};return{get:function(){return a.get("/cards.json").success(function(a){c.cards=a}),c},realCard:b}}]),angular.module("hearthApp").controller("OwnedCtrl",["$scope","cards","owned",function(a,b,c){a.cardList=b.get(),a.owned=c.get(),a.realCard=b.realCard,a.clearData=c.clear,a.order="name",a.reverseSort=!1,a.updateOwned=function(b){b&&b.id&&b.owned&&(a.owned.cards[b.id]=b.owned),c.save()},a.ownAll=function(){a.cardList.cards.forEach(function(b){a.realCard(b)&&a.updateOwned({id:b.id,owned:"legendary"===b.quality?1:2})})}}]),angular.module("hearthApp").service("owned",["storage",function(a){function b(){a.set("cards",d.cards)}function c(){d.cards={},b()}var d={cards:a.get("cards")||{}};return{get:function(){return d},save:b,clear:c}}]),angular.module("hearthApp").controller("LinksCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),function(){var a=io.connect("http://www.hstrny.com:9007");angular.module("hearthApp").service("socket",["$rootScope",function(b){return{on:function(c,d){a.on(c,function(){var c=arguments;b.$apply(function(){d.apply(a,c)})})},emit:function(c,d,e){a.emit(c,d,function(){var c=arguments;b.$apply(function(){e&&e.apply(a,c)})})}}}])}(),angular.module("hearthApp").controller("NavCtrl",["$scope","user","activeTournament","$location","$dialog",function(a,b,c,d,e){a.user=b.get(),a.at=c.get(),a.login=b.login,a.countUsers=b.countUsers,a.navClass=function(a){var b=d.path().substring(1).split("/")[0]||"tournaments";return"string"==typeof a?a===b?"active":"":-1!==a.indexOf(b)?"active":""},a.showlogin=function(){var a=e.dialog({backdrop:!0,keyboard:!0,backdropClick:!0,templateUrl:"views/login-modal.html",controller:"LoginModalCtrl"});a.open().then(function(){})},a.showRegister=function(){var a=e.dialog({backdrop:!0,keyboard:!0,backdropClick:!0,templateUrl:"views/register-modal.html",controller:"RegisterModalCtrl"});a.open().then(function(){})}}]),angular.module("hearthApp").controller("TournamentsCtrl",["$scope","$location","$dialog","socket","tournaments","user","activeTournament","chat",function(a,b,c,d,e,f,g,h){a.user=f.get(),a.tournaments=e.get(),a.at=g.get(),a.chat=h.get(),a.sendChat=h.sendChat,a.join=function(a){var b=c.dialog({backdrop:!0,keyboard:!0,backdropClick:!0,templateUrl:"views/join-modal.html",controller:"JoinModalCtrl",resolve:{tournament:function(){return a}}});b.open().then(function(b){b&&g.join(a)})},a.countUsers=f.countUsers,a.showUsers=!1,d.on("tournaments:joined",function(a){a&&b.path("/play/"+a.participant.tournamentUrl)}),d.on("tournaments:multijoin",function(){alert("You are already in a tournament.")}),a.isActive=function(a){return a&&a.tournament?"pending"===a.tournament.state||"underway"===a.tournament.state?!0:!1:!1},a.orderState=function(a){return a.tournament.state},a.$watch("chat.chatLog.length",function(){var a=document.getElementById("general-chat");a&&setTimeout(function(){a.scrollTop=a.scrollHeight},0)})}]),angular.module("hearthApp").controller("SpectateCtrl",["$scope","$routeParams","socket","tournaments",function(a,b,c,d){function e(){$(".view-iframe").challonge(a.tournamentId,{subdomain:"hs_tourney",theme:"2",multiplier:"1.0",match_width_multiplier:"1.0",show_final_results:"0",show_standings:"0"})}a.tournamentId=b.id,a.t=d.get(),a.found=!0,a.$watch("t.tournaments",function(){a.found=!1,a.t.tournaments.forEach(function(b){b.tournament.url===a.tournamentId&&(a.activeTournament=b,e(),a.found=!0)})})}]),angular.module("hearthApp").service("tournaments",["socket",function(a){var b={tournaments:[]};return a.on("tournaments:list",function(a){b.tournaments=a}),{get:function(){return a.emit("tournaments:list"),b}}}]),angular.module("hearthApp").service("user",["socket",function(a){function b(){e.user.error=null,a.emit("user:login",{battleTag:e.user.userName,password:e.user.password})}function c(){e.user.registererror=null,a.emit("user:register",{battleTag:e.user.userName,password:e.user.password})}function d(){var a=0;for(var b in e.user.userList)a++;return a}var e={user:{userList:{},userName:"",password:"",loggedIn:!1,error:null,registererror:"",registered:!1}};return a.on("user:list",function(a){e.user.userList=a}),a.on("user:login",function(a){e.user.userList[a]={}}),a.on("user:loggedIn",function(a){e.user.loggedIn=!0,e.user.registered=a.registered,$(".hero-unit").addClass("loggedIn")}),a.on("user:loginerror",function(a){e.user.error=a}),a.on("user:registererror",function(a){e.user.registererror=a}),a.on("user:logout",function(a){delete e.user.userList[a]}),a.emit("user:list"),{get:function(){return e},login:b,register:c,countUsers:d}}]),angular.module("hearthApp").service("activeTournament",["socket",function(a){function b(){g.activeTournament.tournament.participants.forEach(function(a){g.idNameMap[a.participant.id]=a.participant.name});var a=g.participant.participant.id,b=!1;g.activeTournament.tournament.matches.forEach(function(c){"open"!==c.match.state||c.match.player1Id!==a&&c.match.player2Id!==a||(g.match&&c.match.round!==g.match.match.round&&(g.matchError=null,g.winnerReport=""),g.match=c,g.match.player1Name=g.idNameMap[c.match.player1Id],g.match.player2Name=g.idNameMap[c.match.player2Id],b=!0)}),b||(g.match=null)}function c(b){a.emit("tournaments:join",b.tournament.url)}function d(){a.emit("tournaments:drop",g.activeTournament.tournament.url)}function e(){a.emit("tournaments:report",{tournamentId:g.activeTournament.tournament.url,matchId:g.match.match.id,winnerId:g.winnerReport})}function f(){var a="/sounds/notify";document.getElementById("sound").innerHTML='<audio autoplay="autoplay"><source src="'+a+'.wav" type="audio/wav" /><source src="'+a+'.wav" type="audio/wav" /><embed hidden="true" autostart="true" loop="false" src="'+a+'.wav" /></audio>'}var g={activeTournament:null,winnerReport:"",match:null,matchError:null,participant:null,idNameMap:{},dropped:!1,eliminated:!1,won:!1,win:!1};return a.on("tournaments:dropped",function(){g.activeTournament=null,g.participant=null,g.dropped=!0}),a.on("tournaments:eliminated",function(){g.activeTournament=null,g.participant=null,g.eliminated=!0}),a.on("tournaments:won",function(){g.activeTournament=null,g.participant=null,g.won=!0}),a.on("tournaments:win",function(){g.win=!0}),a.on("tournaments:joined",function(a){g.participant=a}),a.on("tournaments:activeTournament",function(a){g.activeTournament=a,b(),"complete"===g.activeTournament.tournament.state&&(g.activeTournament=null)}),a.on("tournaments:winnerConflict",function(a){g.match&&g.match.match.id===a.matchId&&(g.matchError=a)}),a.on("tournaments:started",function(a){a.id===g.activeTournament.tournament.url&&f()}),{get:function(){return g},join:c,drop:d,sendResult:e}}]),angular.module("hearthApp").controller("PlayCtrl",["$scope","activeTournament","user","$location","chat","socket","$dialog",function(a,b,c,d,e,f,g){function h(){a.at.activeTournament&&a.at.activeTournament.tournament&&$(".active-iframe").challonge(a.at.activeTournament.tournament.url,{subdomain:"hs_tourney",theme:"2",multiplier:"1.0",match_width_multiplier:"1.0",show_final_results:"0",show_standings:"0"})}a.user=c.get(),a.at=b.get(),a.chat=e.get(),a.sendChat=e.sendChat,a.countUsers=c.countUsers,a.showUsers=!1,a.drop=function(){var a=g.dialog({backdrop:!0,keyboard:!0,backdropClick:!0,templateUrl:"views/drop-modal.html",controller:"DropModalCtrl"});a.open().then(function(){})},a.sendResult=b.sendResult,a.$watch("at.activeTournament.tournament",h),a.$watch("at.participant",function(){a.at.participant||d.path("/tournaments")}),a.isOnline=function(b){return a.user?a.user.user.userList[b]?!0:!1:void 0},a.$watch("at.dropped",function(){if(a.at.dropped){var b=g.dialog({backdrop:!0,keyboard:!0,backdropClick:!0,templateUrl:"views/tournament-end-modal.html",controller:"TournamentEndModalCtrl",resolve:{state:function(){return"dropped"}}});b.open().then(function(){}),a.at.dropped=!1}}),a.$watch("at.eliminated",function(){if(a.at.eliminated){var b=g.dialog({backdrop:!0,keyboard:!0,backdropClick:!0,templateUrl:"views/tournament-end-modal.html",controller:"TournamentEndModalCtrl",resolve:{state:function(){return"eliminated"}}});b.open().then(function(){}),a.at.eliminated=!1}}),a.$watch("at.won",function(){if(a.at.won){var b=g.dialog({backdrop:!0,keyboard:!0,backdropClick:!0,templateUrl:"views/tournament-end-modal.html",controller:"TournamentEndModalCtrl",resolve:{state:function(){return"victory"}}});b.open().then(function(){}),a.at.won=!1}}),a.$watch("at.win",function(){if(a.at.win){var b=g.dialog({backdrop:!0,keyboard:!0,backdropClick:!0,templateUrl:"views/tournament-end-modal.html",controller:"TournamentEndModalCtrl",resolve:{state:function(){return"victorymatch"}}});b.open().then(function(){}),a.at.win=!1}}),a.$watch("chat.tournamentChatLog.length",function(){var a=document.getElementById("tournament-chat");a&&setTimeout(function(){a.scrollTop=a.scrollHeight},0)})}]),angular.module("hearthApp").service("chat",["socket","user",function(a,b){function c(){f.tournamentChatLog=[]}function d(b,c){if(c){var d;d="generalChat"===b?f.chatLog:f.tournamentChatLog,a.emit("chat:message",{room:b,msg:c}),d.push({msg:c,user:e.user.userName})}}var e=b.get(),f={generalChat:"",tournamentChat:"",chatLog:[],tournamentChatLog:[]};return a.on("chat:message",function(a){var b;b="generalChat"===a.room?f.chatLog:f.tournamentChatLog,b.push(a)}),a.on("tournaments:dropped",c),a.on("tournaments:won",c),a.on("tournaments:eliminated",c),{get:function(){return f},sendChat:d}}]),angular.module("hearthApp").controller("BrowseCtrl",["$scope","tournaments",function(a,b){a.tournaments=b.get(),a.orderState=function(a){return"complete"===a.tournament.state?"x":a.tournament.state}}]),angular.module("hearthApp").controller("TournamentEndModalCtrl",["$scope","dialog","state",function(a,b,c){a.state=c,a.ok=function(){$(".modal-backdrop").hide(),b.close("ok")},a.cancel=function(){$(".modal-backdrop").hide(),b.close("cancel")}}]),angular.module("hearthApp").controller("LoginModalCtrl",["$scope","dialog","user",function(a,b,c){a.user=c.get(),a.login=c.login,a.cancel=function(){$(".modal-backdrop").hide(),b.close("cancel")},a.$watch("user.user.loggedIn",function(){a.user.user.loggedIn&&($(".modal-backdrop").hide(),b.close("ok"))})}]),angular.module("hearthApp").controller("DropModalCtrl",["$scope","dialog","activeTournament",function(a,b,c){a.at=c.get(),a.drop=function(){c.drop(),a.cancel()},a.cancel=function(){$(".modal-backdrop").hide(),b.close("cancel")}}]),angular.module("hearthApp").controller("RegisterModalCtrl",["$scope","dialog","user",function(a,b,c){a.user=c.get(),a.register=c.register,a.cancel=function(){$(".modal-backdrop").hide(),b.close("cancel")}}]),angular.module("hearthApp").controller("JoinModalCtrl",["$scope","dialog","tournament",function(a,b,c){a.tournament=c,a.join=function(){b.close(!0)},a.cancel=function(){b.close(!1)}}]);
